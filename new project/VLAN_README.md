# Поддержка VLAN в развертывании стендов

## Обзор

Реализована поддержка VLAN в настройке сети при развертывании стендов. Система автоматически создает VLAN-aware bridge'ы и настраивает виртуальные машины с соответствующими VLAN тегами.

## Формат конфигурации

### Синтаксис имен bridge'ей

- **Обычный bridge**: `vmbr0`, `vmbr1`, etc.
- **Зарезервированный bridge**: `**vmbr0` (создается принудительно)
- **Alias без VLAN**: `hq`, `inet`, `dmz`, etc.
- **Alias с VLAN**: `hq.100`, `inet.200`, `dmz.300`, etc.

### Пример конфигурации

```yaml
machines:
- device_type: linux
  full_clone: false
  name: gw
  networks:
  - bridge: vmbr0          # Обычный bridge
  - bridge: hq        # Alias 'hq'
  template_node: pve1
  template_vmid: 100

- device_type: linux
  full_clone: false
  name: hq-server
  networks:
  - bridge: hq.100         # Тот же alias 'hq' с VLAN 100
  template_node: pve1
  template_vmid: 100
```

## Как это работает

### 1. Разбор имен bridge'ей

Система разбирает имена bridge'ей по следующему алгоритму:

- `hq.100` → alias: `hq`, vlan_id: `100`
- `inet.200` → alias: `inet`, vlan_id: `200`
- `vmbr0` → alias: `vmbr0`, vlan_id: `None`
- `hq` → alias: `hq`, vlan_id: `None`

### 2. Создание bridge'ей

Для каждого уникального alias создается один bridge:

- **Анализ всех алиасов**: Перед созданием bridge'ей система анализирует все сети и определяет, есть ли среди алиасов хотя бы один с VLAN
- **Создание VLAN-aware bridge**: Если хотя бы один алиас для bridge'а содержит VLAN, то bridge создается как VLAN-aware с параметрами `bridge_vlan_aware=yes` и `type=bridge`
- **Кэширование**: Одни и те же алиасы всегда используют один bridge для пользователя

### 3. Настройка сетевых интерфейсов

Для каждого сетевого интерфейса генерируется конфигурация:

**Без VLAN (например, `hq`):**
```bash
model=virtio,bridge=vmbr1000,firewall=1
```

**С VLAN (например, `hq.100`):**
```bash
model=virtio,bridge=vmbr1000,tag=100,firewall=1
```

## Параметры сети для машин

Согласно требованиям:

### VM1 (первая машина с alias `hq`):
- `hq` является alias без VLAN
- Выбирается свободный bridge (например, `vmbr1000`)
- Если в конфигурации есть другие машины с `hq.100`, то bridge создается как VLAN-aware
- Настройка интерфейса: без tag параметра

### VM2 (вторая машина с alias `hq.100`):
- `hq.100` является alias с VLAN 100
- Назначается тот же bridge (`vmbr1000`)
- При подключении моста передается параметр `tag=100`
- Настройка интерфейса: с tag параметром

### Важное правило:
VLAN может быть указан только с одной стороны bridge. Если хотя бы один алиас содержит VLAN, bridge создается как VLAN-aware, но tag используется только для интерфейсов, где явно указан VLAN в конфигурации.

## Кэширование bridge mapping

Система использует глобальный кэш для хранения соответствий:
- `пользователь:нода` → `bridge_mapping`
- Одни и те же alias всегда используют один bridge для пользователя

## Автоматическое выделение bridge'ей

Bridge'ы выделяются автоматически по схеме:

- `hq` → `vmbr1000+` (начиная с 1000)
- `inet` → `vmbr2000+` (начиная с 2000)
- Другие → `vmbr9000+` (начиная с 9000)

## Логирование

Система предоставляет подробное логирование:

```
INFO: Создаем VLAN-aware bridge vmbr1000 для alias 'hq' пользователя user1 на ноде pve1
INFO: Пользователь user1: alias 'hq' (VLAN 100) -> bridge 'vmbr1000' (сохранено в кэш)
INFO: Настраиваем VLAN интерфейс net1 для VM: bridge=vmbr1000, tag=100
```

## Тестирование

Для проверки функционала используется тестовый скрипт `test_vlan.py`:

```bash
python3 test_vlan.py
```

Тесты проверяют:
- Разбор имен bridge'ей с VLAN
- Создание VLAN-aware bridge'ей
- Генерацию сетевых конфигураций

## Преимущества

1. **Автоматизация**: Полностью автоматическое создание и настройка VLAN
2. **Консистентность**: Одни и те же alias всегда используют один bridge
3. **Гибкость**: Поддержка как обычных, так и VLAN сетей
4. **Масштабируемость**: Автоматическое выделение свободных bridge'ей
5. **Кэширование**: Оптимизация повторных развертываний

## Ограничения

- VLAN ID должны быть числами (1-4094)
- Максимум 100 попыток поиска свободного bridge'а
- Поддержка только для Linux виртуальных машин
