# Newest Project - Модульная система развертывания виртуальных машин

## Цель проекта

Система для автоматизированного развертывания виртуальных машин в кластере Proxmox VE с поддержкой:
- Модульной архитектуры
- Интеллектуальной балансировки нагрузки
- Гибкого управления шаблонами
- Расширенной настройки сети с поддержкой VLAN
- Мониторинга производительности
- Кеширования
- Безопасности

## Архитектура разработки

Проект разрабатывается по модульному принципу:
1. Каждая функция реализуется как отдельный модуль
2. Каждый модуль тестируется независимо
3. Модули интегрируются в единую систему

## Структура проекта

```
newest_project/
├── core/                          # Ядро системы
│   ├── modules/                   # Основные модули
│   │   ├── __init__.py
│   │   ├── connection/            # Управление подключениями
│   │   ├── config/                # Управление конфигурацией
│   │   ├── deployment/            # Развертывание VM
│   │   ├── network/               # Управление сетью
│   │   ├── templates/             # Управление шаблонами
│   │   ├── users/                 # Управление пользователями
│   │   └── balancing/             # Балансировка нагрузки
│   ├── utils/                     # Утилиты
│   │   ├── __init__.py
│   │   ├── logger.py              # Логирование
│   │   ├── validator.py           # Валидация
│   │   └── cache.py               # Кеширование
│   └── interfaces/                # Интерфейсы модулей
├── ui/                            # Пользовательский интерфейс
│   ├── __init__.py
│   ├── main_menu.py               # Главное меню
│   ├── connection_menu.py         # Меню управления подключениями
│   ├── config_menu.py             # Меню управления конфигурацией
│   ├── deployment_menu.py         # Меню развертывания
│   ├── network_menu.py            # Меню управления сетью
│   ├── user_menu.py               # Меню управления пользователями
│   └── cleanup_menu.py            # Меню очистки ресурсов
├── data/                          # Конфигурационные файлы
│   ├── connections.yml            # Конфигурация подключений
│   ├── deployment_config.yml      # Конфигурация развертывания
│   └── users.yml                  # Список пользователей
├── main.py                        # Точка входа
└── requirements.txt               # Зависимости
```

## Алгоритм работы функций

### 1. Управление подключениями (Connection Manager)
**Вход:** Данные подключения (host, user, password/token)
**Выход:** Аутентифицированное соединение с Proxmox API
**Логика:**
- Валидация параметров подключения
- Аутентификация по паролю или токену
- Тестирование соединения
- Кеширование активных соединений

### 2. Управление конфигурацией (Config Manager)
**Вход:** YAML файлы конфигурации
**Выход:** Структурированные объекты конфигурации
**Логика:**
- Загрузка и парсинг YAML файлов
- Валидация структуры конфигурации
- Предоставление интерфейса доступа к конфигурации

### 3. Управление пользователями (User Manager)
**Вход:** Список пользователей в формате user@pve
**Выход:** Структурированный список пользователей
**Логика:**
- Парсинг списка пользователей
- Валидация формата пользователей
- Группировка пользователей по пулам

### 4. Управление сетью (Network Manager)
**Вход:** Конфигурация сетей с поддержкой VLAN
**Выход:** Настроенные сетевые интерфейсы
**Логика:**
- Разбор алиасов сетей (bridge.vlan)
- Создание VLAN-aware bridge'ей
- Генерация конфигурации сетевых интерфейсов
- Кеширование соответствий алиасов bridge'ам

### 5. Управление шаблонами (Template Manager)
**Вход:** Идентификаторы шаблонов VM
**Выход:** Доступные шаблоны для развертывания
**Логика:**
- Получение списка доступных шаблонов
- Валидация существования шаблонов
- Подготовка шаблонов для клонирования

### 6. Развертывание VM (Deployment Manager)
**Вход:** Конфигурация развертывания, пользователи, шаблоны
**Выход:** Созданные виртуальные машины
**Логика:**
- Выбор стратегии развертывания
- Распределение VM по нодам кластера
- Клонирование шаблонов
- Настройка сетевых интерфейсов
- Назначение ресурсов

### 7. Балансировка нагрузки (Load Balancer)
**Вход:** Метрики использования нод кластера
**Выход:** Рекомендации по распределению VM
**Логика:**
- Сбор метрик использования ресурсов
- Анализ загруженности нод
- Выбор оптимальной ноды для размещения

## Последовательность разработки

### Этап 1: Базовая инфраструктура
1. **Logger** - система логирования
2. **Validator** - базовая валидация
3. **Cache** - кеширование данных

### Этап 2: Управление подключениями
1. **Connection Manager** - управление подключениями к Proxmox
2. **Proxmox Client** - клиент API Proxmox

### Этап 3: Управление конфигурацией и пользователями
1. **Config Manager** - управление конфигурацией развертывания
2. **User Manager** - управление пользователями

### Этап 4: Сетевая инфраструктура
1. **Network Manager** - управление сетью с поддержкой VLAN
2. **Bridge Manager** - управление bridge'ами

### Этап 5: Развертывание
1. **Template Manager** - управление шаблонами
2. **VM Manager** - управление виртуальными машинами
3. **Deployment Manager** - основная логика развертывания

### Этап 6: Балансировка и мониторинг
1. **Load Balancer** - балансировка нагрузки
2. **Metrics Collector** - сбор метрик

### Этап 7: Пользовательский интерфейс
1. **Menu System** - система меню
2. **Интеграция всех модулей**

### Этап 8: Тестирование и интеграция
1. **Модульные тесты** для каждой функции
2. **Интеграционные тесты** для взаимодействия модулей
3. **Тестирование полного workflow**

## Тестирование модулей

Каждый модуль тестируется отдельно с использованием реальных данных и ручной проверки:

### Тестирование Connection Manager
```python
# Тестирование подключения к реальному Proxmox серверу
def test_connection_manually():
    conn_manager = ConnectionManager()

    # Тестирование подключения
    connection = conn_manager.create_connection({
        'host': '192.168.1.100:8006',
        'user': 'root@pam',
        'password': 'password'
    })

    # Ручная проверка:
    # 1. Проверить статус подключения в логах
    # 2. Выполнить тестовый запрос к API
    # 3. Убедиться в успешной аутентификации

    return connection
```

### Тестирование Network Manager
```python
# Тестирование настройки сети с VLAN
def test_network_manually():
    network_manager = NetworkManager()

    # Тестирование разбора алиасов
    bridge_config = network_manager.parse_bridge_alias("hq.100")

    # Ручная проверка:
    # 1. Проверить корректность разбора алиаса
    # 2. Создать VLAN-aware bridge
    # 3. Настроить сетевые интерфейсы VM
    # 4. Проверить конфигурацию в Proxmox

    return bridge_config
```

## Интеграция модулей

После тестирования отдельных модулей происходит их интеграция:

```python
# Пример интеграции в главном приложении
class DeployStandApplication:
    def __init__(self):
        self.connection_manager = ConnectionManager()
        self.config_manager = ConfigManager()
        self.deployment_manager = DeploymentManager()
        self.network_manager = NetworkManager()

    def deploy_stands(self, users, config):
        # Получение подключения
        connection = self.connection_manager.get_connection()

        # Загрузка конфигурации
        deployment_config = self.config_manager.load_config(config)

        # Развертывание с настройкой сети
        results = self.deployment_manager.deploy(
            users, deployment_config, connection
        )

        return results
```

## Преимущества подхода

1. **Модульность** - каждый компонент независим
2. **Тестируемость** - каждый модуль тестируется отдельно
3. **Надежность** - ошибки в одном модуле не влияют на другие
4. **Расширяемость** - легко добавлять новые функции
5. **Поддерживаемость** - проще отлаживать и модифицировать
