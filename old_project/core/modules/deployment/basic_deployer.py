"""
–ë–∞–∑–æ–≤—ã–π –º–æ–¥—É–ª—å —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã—Ö –º–∞—à–∏–Ω

–†–µ–∞–ª–∏–∑—É–µ—Ç –ø—Ä–æ—Å—Ç—É—é —Å—Ç—Ä–∞—Ç–µ–≥–∏—é —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã—Ö –º–∞—à–∏–Ω –Ω–∞ –æ–¥–Ω—É –Ω–æ–¥—É
—Å –±–∞–∑–æ–≤—ã–º–∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—è–º–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —à–∞–±–ª–æ–Ω–∞–º–∏ –∏ —Å–µ—Ç—å—é.
"""

import logging
import secrets
import string
from typing import Dict, List, Any
from core.interfaces.deployment_interface import DeploymentInterface
from core.proxmox.proxmox_client import ProxmoxClient

logger = logging.getLogger(__name__)


class BasicDeployer(DeploymentInterface):
    """–ë–∞–∑–æ–≤–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã—Ö –º–∞—à–∏–Ω"""

    def __init__(self, proxmox_client: ProxmoxClient):
        """
        –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑–æ–≤–æ–≥–æ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞—Ç–µ–ª—è

        Args:
            proxmox_client: –ö–ª–∏–µ–Ω—Ç –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Proxmox API
        """
        self.proxmox = proxmox_client

    def deploy_configuration(self, users: List[str], config: Dict[str, Any],
                           node_selection: str = "auto", target_node: str = None) -> Dict[str, str]:
        """
        –†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã—Ö –º–∞—à–∏–Ω

        Args:
            users: –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è
            config: –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è
            node_selection: –°—Ç—Ä–∞—Ç–µ–≥–∏—è –≤—ã–±–æ—Ä–∞ –Ω–æ–¥—ã ("auto", "specific", "balanced")
            target_node: –¶–µ–ª–µ–≤–∞—è –Ω–æ–¥–∞ (–µ—Å–ª–∏ node_selection="specific")

        Returns:
            –°–ª–æ–≤–∞—Ä—å {–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: –ø–∞—Ä–æ–ª—å}
        """
        results = {}

        try:
            # –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ü–µ–ª–µ–≤—É—é –Ω–æ–¥—É
            nodes = self.proxmox.get_nodes()
            if node_selection == "specific" and target_node:
                if target_node not in nodes:
                    raise ValueError(f"–¶–µ–ª–µ–≤–∞—è –Ω–æ–¥–∞ {target_node} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞")
                selected_node = target_node
            else:
                # –í—ã–±—Ä–∞—Ç—å –ø–µ—Ä–≤—É—é –¥–æ—Å—Ç—É–ø–Ω—É—é –Ω–æ–¥—É
                selected_node = nodes[0] if nodes else None

            if not selected_node:
                raise ValueError("–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –Ω–æ–¥ –¥–ª—è —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è")

            logger.info(f"–í—ã–±—Ä–∞–Ω–∞ –Ω–æ–¥–∞ –¥–ª—è —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è: {selected_node}")

            # –†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            for user in users:
                user_result = self._deploy_for_user(user, config, selected_node)
                results.update(user_result)

            # –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–µ—Ç–µ–≤—ã–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –Ω–∞ –∑–∞–¥–µ–π—Å—Ç–≤–æ–≤–∞–Ω–Ω—ã—Ö –Ω–æ–¥–∞—Ö –ø–æ—Å–ª–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è
            affected_nodes = set()
            for user in users:
                pool_name = user.split('@')[0]
                # –î–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –Ω–∞ –∫–∞–∫—É—é –Ω–æ–¥—É —Ä–∞–∑–≤–µ—Ä–Ω—É–ª–∏
                # –í –±–∞–∑–æ–≤–æ–º —Å–ª—É—á–∞–µ –≤—Å–µ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—ã –Ω–∞ selected_node
                affected_nodes.add(selected_node)

            if affected_nodes:
                print("üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–µ—Ç–µ–≤—ã—Ö –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π –Ω–∞ –∑–∞–¥–µ–π—Å—Ç–≤–æ–≤–∞–Ω–Ω—ã—Ö –Ω–æ–¥–∞—Ö...")
                for node in affected_nodes:
                    try:
                        if self.proxmox.reload_node_network(node):
                            print(f"  ‚úÖ –°–µ—Ç—å –Ω–æ–¥—ã {node} –æ–±–Ω–æ–≤–ª–µ–Ω–∞")
                        else:
                            print(f"  ‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Å–µ—Ç—å –Ω–æ–¥—ã {node}")
                    except Exception as e:
                        print(f"  ‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–µ—Ç–∏ –Ω–æ–¥—ã {node}: {e}")

            logger.info(f"–†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ –¥–ª—è {len(results)} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π")
            return results

        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è: {e}")
            raise

    def _deploy_for_user(self, user: str, config: Dict[str, Any], target_node: str) -> Dict[str, str]:
        """
        –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –¥–ª—è –æ–¥–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

        Args:
            user: –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            config: –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è
            target_node: –¶–µ–ª–µ–≤–∞—è –Ω–æ–¥–∞

        Returns:
            –°–ª–æ–≤–∞—Ä—å {–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: –ø–∞—Ä–æ–ª—å}
        """
        try:
            # –°–æ–∑–¥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –ø—É–ª
            success, password = self._create_user_and_pool(user)
            if not success:
                raise Exception(f"–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user}")

            # –°–æ–∑–¥–∞—Ç—å –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–µ –º–∞—à–∏–Ω—ã
            pool_name = user.split('@')[0]

            # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–º –æ–±—Ä–∞–∑–æ–º
            user_was_existing = self.proxmox.user_exists(user)

            if user_was_existing:
                # –î–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –µ—Å–ª–∏ VM —É–∂–µ —Å–æ–∑–¥–∞–Ω—ã
                if self._check_existing_user_vms(pool_name, config, target_node):
                    logger.info(f"‚ÑπÔ∏è –î–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user} VM —É–∂–µ —Å–æ–∑–¥–∞–Ω—ã –∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã")
                    return {user: ""}  # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Å—Ç–æ–π –ø–∞—Ä–æ–ª—å –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

            # –°–æ–∑–¥–∞—Ç—å –º–∞—à–∏–Ω—ã –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–æ–≤—ã–π –∏–ª–∏ —É –Ω–µ–≥–æ –Ω–µ—Ç –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö VM
            for machine_config in config.get('machines', []):
                self._create_machine(machine_config, target_node, pool_name)

            logger.info(f"–†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user} –∑–∞–≤–µ—Ä—à–µ–Ω–æ")
            return {user: password}

        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user}: {e}")
            raise

    def _create_user_and_pool(self, user: str) -> tuple[bool, str]:
        """
        –°–æ–∑–¥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –ø—É–ª —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è

        Args:
            user: –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

        Returns:
            –ö–æ—Ä—Ç–µ–∂ (—É—Å–ø–µ—Ö, –ø–∞—Ä–æ–ª—å)
        """
        try:
            pool_name = user.split('@')[0]
            password = None

            # –®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
            user_exists = self.proxmox.user_exists(user)

            if not user_exists:
                # –°–æ–∑–¥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
                password = self._generate_password()
                if not self.proxmox.create_user(user, password):
                    return False, ""
                logger.info(f"‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user} —Å–æ–∑–¥–∞–Ω")
            else:
                logger.info(f"‚ÑπÔ∏è –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user} —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç")

            # –®–∞–≥ 2: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –ø—É–ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            pool_exists = self.proxmox.pool_exists(pool_name)

            if not pool_exists:
                # –°–æ–∑–¥–∞—Ç—å –ø—É–ª –µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
                if not self.proxmox.create_pool(pool_name, f"Pool for {user}"):
                    if not user_exists:
                        self._cleanup_user(user)
                    return False, ""
                logger.info(f"‚úÖ –ü—É–ª {pool_name} —Å–æ–∑–¥–∞–Ω")

                # –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∞–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ –ø—É–ª (—Ä–æ–ª—å PVEVMAdmin)
                permissions = ["PVEVMAdmin"]
                if not self.proxmox.set_pool_permissions(user, pool_name, permissions):
                    if not user_exists:
                        self._cleanup_user(user)
                    self._cleanup_pool(pool_name)
                    return False, ""
                logger.info(f"‚úÖ –ü—Ä–∞–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user} –Ω–∞ –ø—É–ª {pool_name} —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã")

            else:
                logger.info(f"‚ÑπÔ∏è –ü—É–ª {pool_name} —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç")

                # –®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–∞–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –ø—É–ª
                existing_permissions = self.proxmox.get_pool_permissions(user, pool_name)
                required_permissions = ["PVEVMAdmin"]  # –¢–µ–ø–µ—Ä—å –ø—Ä–æ–≤–µ—Ä—è–µ–º —Ä–æ–ª—å PVEVMAdmin

                missing_permissions = [perm for perm in required_permissions if perm not in existing_permissions]

                if missing_permissions:
                    logger.warning(f"‚ö†Ô∏è –£ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user} –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç —Ä–æ–ª—å PVEVMAdmin –Ω–∞ –ø—É–ª {pool_name}")
                    # –ü–æ–ø—ã—Ç–∞—Ç—å—Å—è —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ä–æ–ª—å
                    if not self.proxmox.set_pool_permissions(user, pool_name, missing_permissions):
                        logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ä–æ–ª—å PVEVMAdmin –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user}")
                    else:
                        logger.info(f"‚úÖ –†–æ–ª—å PVEVMAdmin —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user}")
                else:
                    logger.info(f"‚úÖ –ü—Ä–∞–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user} –Ω–∞ –ø—É–ª {pool_name} –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã")

            # –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–ª, –ø–∞—Ä–æ–ª—å –ø—É—Å—Ç–æ–π (–Ω–µ –º–µ–Ω—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ)
            if user_exists:
                password = ""  # –ù–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø–∞—Ä–æ–ª—å –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

            logger.info(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user} –≥–æ—Ç–æ–≤ –∫ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—é")
            return True, password or ""

        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –ø—É–ª–∞: {e}")
            return False, ""

    def _create_machine(self, machine_config: Dict[str, Any], target_node: str, pool: str) -> None:
        """
        –°–æ–∑–¥–∞—Ç—å –≤–∏—Ä—Ç—É–∞–ª—å–Ω—É—é –º–∞—à–∏–Ω—É

        Args:
            machine_config: –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –º–∞—à–∏–Ω—ã
            target_node: –¶–µ–ª–µ–≤–∞—è –Ω–æ–¥–∞
            pool: –ò–º—è –ø—É–ª–∞
        """
        try:
            # –ü–æ–ª—É—á–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –º–∞—à–∏–Ω—ã
            template_node = machine_config.get('template_node', target_node)
            template_vmid = machine_config['template_vmid']
            device_type = machine_config.get('device_type', 'linux')
            name = machine_config.get('name', f"vm-{template_vmid}-{pool}")
            full_clone = machine_config.get('full_clone', False)

            # –ü–æ–ª—É—á–∏—Ç—å —Å–ª–µ–¥—É—é—â–∏–π VMID
            new_vmid = self.proxmox.get_next_vmid()

            # –ö–ª–æ–Ω–∏—Ä–æ–≤–∞—Ç—å –≤–∏—Ä—Ç—É–∞–ª—å–Ω—É—é –º–∞—à–∏–Ω—É
            task_id = self.proxmox.clone_vm(
                template_node=template_node,
                template_vmid=template_vmid,
                target_node=target_node,
                new_vmid=new_vmid,
                name=name,
                pool=pool,
                full_clone=full_clone
            )

            # –û–∂–∏–¥–∞—Ç—å –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
            if not self.proxmox.wait_for_task(task_id, template_node):
                raise Exception(f"–û—à–∏–±–∫–∞ –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è VM {new_vmid}")

            # –ù–∞—Å—Ç—Ä–æ–∏—Ç—å —Å–µ—Ç—å –µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω–∞
            networks = machine_config.get('networks', [])
            if networks:
                self._configure_machine_network(new_vmid, target_node, networks, pool, device_type)

            logger.info(f"–ú–∞—à–∏–Ω–∞ {name} (VMID: {new_vmid}) —Å–æ–∑–¥–∞–Ω–∞ –≤ –ø—É–ª–µ {pool}")

        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –º–∞—à–∏–Ω—ã: {e}")
            raise

    def _configure_machine_network(self, vmid: int, node: str, networks: List[Dict],
                                 pool: str, device_type: str) -> None:
        """
        –ù–∞—Å—Ç—Ä–æ–∏—Ç—å —Å–µ—Ç—å –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–π –º–∞—à–∏–Ω—ã

        Args:
            vmid: VMID –º–∞—à–∏–Ω—ã
            node: –ù–æ–¥–∞ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è
            networks: –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–µ—Ç–µ–π
            pool: –ò–º—è –ø—É–ª–∞
            device_type: –¢–∏–ø —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
        """
        try:
            network_configs = {}

            # –û–±—Ä–∞–±–æ—Ç–∫–∞ ecorouter —É—Å—Ç—Ä–æ–π—Å—Ç–≤
            if device_type == 'ecorouter':
                # –°–æ–∑–¥–∞—Ç—å MAC –∞–¥—Ä–µ—Å –¥–ª—è —É–ø—Ä–∞–≤–ª—è—é—â–µ–≥–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
                mac = self._generate_mac_address()
                network_configs['net0'] = f'model=vmxnet3,bridge=vmbr0,macaddr={mac},link_down=1'

            # –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã
            for i, network in enumerate(networks):
                bridge = network.get('bridge', f'vmbr{i+1}')
                net_id = f"net{i+1}" if device_type != 'ecorouter' else f"net{i+2}"

                if device_type == 'ecorouter':
                    mac = self._generate_mac_address()
                    network_configs[net_id] = f'model=vmxnet3,bridge={bridge},macaddr={mac}'
                else:
                    network_configs[net_id] = f'model=virtio,bridge={bridge},firewall=1'

            # –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Å–µ—Ç–µ–≤—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
            if not self.proxmox.configure_vm_network(node, vmid, network_configs):
                raise Exception(f"–û—à–∏–±–∫–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–µ—Ç–∏ VM {vmid}")

            logger.info(f"–°–µ—Ç—å VM {vmid} –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞")

        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–µ—Ç–∏ VM {vmid}: {e}")
            raise

    def _generate_password(self, length: int = 8) -> str:
        """–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Å–ª—É—á–∞–π–Ω—ã–π –ø–∞—Ä–æ–ª—å –¥–ª—è –æ–±—É—á–∞—é—â–∏—Ö —Å—Ç–µ–Ω–¥–æ–≤"""
        alphabet = string.digits  # –¢–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã –¥–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –æ–±—É—á–µ–Ω–∏–∏
        return ''.join(secrets.choice(alphabet) for _ in range(length))

    def _generate_mac_address(self) -> str:
        """–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Å–ª—É—á–∞–π–Ω—ã–π MAC –∞–¥—Ä–µ—Å"""
        mac = [0x52, 0x54, 0x00]  # QEMU/Libvirt prefix
        mac.extend(secrets.randbelow(256) for _ in range(3))
        return ':'.join(f'{b:02x}' for b in mac)

    def _cleanup_user(self, user: str) -> None:
        """–û—á–∏—Å—Ç–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        try:
            # –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É —É–¥–∞–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            logger.info(f"–û—á–∏—Å—Ç–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user}")
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user}: {e}")

    def _cleanup_user_and_pool(self, user: str, pool: str) -> None:
        """–û—á–∏—Å—Ç–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –ø—É–ª"""
        try:
            # –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É —É–¥–∞–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –ø—É–ª–∞
            logger.info(f"–û—á–∏—Å—Ç–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user} –∏ –ø—É–ª–∞ {pool}")
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –ø—É–ª–∞: {e}")

    def _cleanup_pool(self, pool: str) -> None:
        """–û—á–∏—Å—Ç–∏—Ç—å –ø—É–ª"""
        try:
            # –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É —É–¥–∞–ª–µ–Ω–∏—è –ø—É–ª–∞
            logger.info(f"–û—á–∏—Å—Ç–∫–∞ –ø—É–ª–∞ {pool}")
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –ø—É–ª–∞ {pool}: {e}")

    def _check_existing_user_vms(self, pool_name: str, config: Dict[str, Any], target_node: str) -> bool:
        """
        –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ VM –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

        Args:
            pool_name: –ò–º—è –ø—É–ª–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            config: –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è
            target_node: –¶–µ–ª–µ–≤–∞—è –Ω–æ–¥–∞

        Returns:
            True –µ—Å–ª–∏ –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ VM —Å—É—â–µ—Å—Ç–≤—É—é—Ç –∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
        """
        try:
            # –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ VM –≤ –ø—É–ª–µ
            pool_vms = self.proxmox.get_pool_vms(pool_name)

            if not pool_vms:
                logger.info(f"–í –ø—É–ª–µ {pool_name} –Ω–µ—Ç –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã—Ö –º–∞—à–∏–Ω")
                return False

            expected_machines = config.get('machines', [])
            if len(pool_vms) != len(expected_machines):
                logger.info(f"–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ VM –≤ –ø—É–ª–µ {pool_name} –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ "
                           f"(–Ω–∞–π–¥–µ–Ω–æ {len(pool_vms)}, –æ–∂–∏–¥–∞–µ—Ç—Å—è {len(expected_machines)})")
                return False

            # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–∞–∂–¥—É—é VM –≤ –ø—É–ª–µ
            for vm_member in pool_vms:
                vmid = vm_member.get('vmid')
                if not vmid:
                    continue

                # –ù–∞–π—Ç–∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –º–∞—à–∏–Ω—ã
                matching_config = None
                for machine_config in expected_machines:
                    # –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º –ø–æ template_vmid –∏–ª–∏ –∏–º–µ–Ω–∏
                    expected_template = machine_config.get('template_vmid')
                    vm_name = vm_member.get('name', '')
                    expected_name = machine_config.get('name', f"vm-{expected_template}-{pool_name}")

                    if str(expected_template) in vm_name or expected_name in vm_name:
                        matching_config = machine_config
                        break

                if not matching_config:
                    logger.info(f"VM {vmid} ({vm_member.get('name', 'unnamed')}) –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏")
                    return False

                # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–µ—Ç–µ–≤—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
                networks = matching_config.get('networks', [])
                if networks:
                    if not self.proxmox.check_vm_network_config(target_node, vmid, networks):
                        logger.debug(f"–°–µ—Ç–µ–≤–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è VM {vmid} –ø—Ä–æ–≤–µ—Ä–µ–Ω–∞")
                        # –ù–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º False - —Ç–æ–ª—å–∫–æ –ª–æ–≥–∏—Ä—É–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ

            logger.info(f"–í—Å–µ VM –≤ –ø—É–ª–µ {pool_name} —Å—É—â–µ—Å—Ç–≤—É—é—Ç –∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã")
            return True

        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö VM –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {e}")
            return False

    def validate_config(self, config: Dict[str, Any]) -> bool:
        """
        –í–∞–ª–∏–¥–∞—Ü–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è

        Args:
            config: –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏

        Returns:
            True –µ—Å–ª–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –≤–∞–ª–∏–¥–Ω–∞
        """
        try:
            # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è —Å–µ–∫—Ü–∏–∏ machines
            if 'machines' not in config:
                logger.error("–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç —Å–µ–∫—Ü–∏—é 'machines'")
                return False

            machines = config['machines']
            if not isinstance(machines, list) or len(machines) == 0:
                logger.error("–°–µ–∫—Ü–∏—è 'machines' –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –Ω–µ–ø—É—Å—Ç—ã–º —Å–ø–∏—Å–∫–æ–º")
                return False

            # –í–∞–ª–∏–¥–∞—Ü–∏—è –∫–∞–∂–¥–æ–π –º–∞—à–∏–Ω—ã
            for i, machine in enumerate(machines):
                if not self._validate_machine_config(machine, i):
                    return False

            return True

        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏: {e}")
            return False

    def _validate_machine_config(self, machine: Dict[str, Any], index: int) -> bool:
        """
        –í–∞–ª–∏–¥–∞—Ü–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –æ–¥–Ω–æ–π –º–∞—à–∏–Ω—ã

        Args:
            machine: –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –º–∞—à–∏–Ω—ã
            index: –ò–Ω–¥–µ–∫—Å –º–∞—à–∏–Ω—ã –≤ —Å–ø–∏—Å–∫–µ

        Returns:
            True –µ—Å–ª–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –≤–∞–ª–∏–¥–Ω–∞
        """
        required_fields = ['template_vmid']
        optional_fields = ['device_type', 'name', 'template_node', 'networks', 'full_clone']

        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π
        for field in required_fields:
            if field not in machine:
                logger.error(f"–ú–∞—à–∏–Ω–∞ {index}: –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ '{field}'")
                return False

        # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–∞ template_vmid
        if not isinstance(machine['template_vmid'], int):
            logger.error(f"–ú–∞—à–∏–Ω–∞ {index}: –ø–æ–ª–µ 'template_vmid' –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —á–∏—Å–ª–æ–º")
            return False

        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ–ø—É—Å—Ç–∏–º—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π
        if 'device_type' in machine:
            if machine['device_type'] not in ['linux', 'ecorouter']:
                logger.error(f"–ú–∞—à–∏–Ω–∞ {index}: –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º—ã–π —Ç–∏–ø —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ '{machine['device_type']}'")
                return False

        # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–∞ full_clone
        if 'full_clone' in machine:
            if not isinstance(machine['full_clone'], bool):
                logger.error(f"–ú–∞—à–∏–Ω–∞ {index}: –ø–æ–ª–µ 'full_clone' –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å true/false")
                return False

        # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Ç–µ–≤–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
        if 'networks' in machine:
            if not isinstance(machine['networks'], list):
                logger.error(f"–ú–∞—à–∏–Ω–∞ {index}: –ø–æ–ª–µ 'networks' –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —Å–ø–∏—Å–∫–æ–º")
                return False

            for j, network in enumerate(machine['networks']):
                if not isinstance(network, dict):
                    logger.error(f"–ú–∞—à–∏–Ω–∞ {index}, —Å–µ—Ç—å {j}: –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –æ–±—ä–µ–∫—Ç–æ–º")
                    return False

                if 'bridge' not in network:
                    logger.error(f"–ú–∞—à–∏–Ω–∞ {index}, —Å–µ—Ç—å {j}: –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –ø–æ–ª–µ 'bridge'")
                    return False

        return True

    def get_deployment_status(self, deployment_id: str) -> Dict[str, Any]:
        """
        –ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç—É—Å —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è

        Args:
            deployment_id: ID —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è

        Returns:
            –°–ª–æ–≤–∞—Ä—å —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è
        """
        # –ó–∞–≥–ª—É—à–∫–∞ - –≤ —Ä–µ–∞–ª—å–Ω–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –∑–¥–µ—Å—å –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ª–æ–≥–∏–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞
        return {
            'deployment_id': deployment_id,
            'status': 'unknown',
            'message': '–°—Ç–∞—Ç—É—Å —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –≤ –±–∞–∑–æ–≤–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏'
        }
